# 功能

- 消息通信时序
- 2024-5-16
- zuiyu1998

## 概述

next-im 的消息通信时序图，用于整体设计。

## 指南级别的解释

1. 向 api 服务器发送登录请求,api 服务器向缓存设置用户的状态,并获取可用的 msg 服务器地址发送给客户端。
2. 客户通过握手，连接 msg 服务器,并且设置心跳。
3. 客户端 A 发送消息到服务器,msg 服务器从消息 id 服务获取消息 id，之后发送到消息推送服务器，同时返回响应。
4. 消息推送服务器将消息推送给 kafka。
5. 消息消费服务器获取消息，向数据库服务和推送服务发送消息。
6. 数据库服务存储响应的聊天消息
7. 推送服务向 msg 服务发送消息，
8. msg 服务向在线的客户 B 发送消息

## 未解决的问题

msg 服务器的路由分配，选择可用空闲的 msg 服务器。
